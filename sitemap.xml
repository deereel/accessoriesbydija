<?php
header('Content-Type: application/xml; charset=utf-8');

// Include database config
require_once 'config/database.php';

$base_url = 'https://accessoriesbydija.uk';

echo '<?xml version="1.0" encoding="UTF-8"?>';
echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" xmlns:image="http://www.google.com/schemas/sitemap-image/1.1">';

// Static pages
$static_pages = [
    ['url' => '/', 'priority' => '1.0', 'changefreq' => 'daily'],
    ['url' => '/products.php', 'priority' => '0.9', 'changefreq' => 'daily'],
    ['url' => '/new-arrivals.php', 'priority' => '0.8', 'changefreq' => 'weekly'],
    ['url' => '/custom-jewelry.php', 'priority' => '0.8', 'changefreq' => 'monthly'],
    ['url' => '/gift-guide.php', 'priority' => '0.7', 'changefreq' => 'monthly'],
    ['url' => '/contact.php', 'priority' => '0.6', 'changefreq' => 'monthly'],
    ['url' => '/faq.php', 'priority' => '0.7', 'changefreq' => 'monthly'],
    ['url' => '/care-guide.php', 'priority' => '0.7', 'changefreq' => 'monthly'],
    ['url' => '/returns.php', 'priority' => '0.6', 'changefreq' => 'monthly'],
    ['url' => '/privacy.php', 'priority' => '0.5', 'changefreq' => 'yearly'],
    ['url' => '/login.php', 'priority' => '0.4', 'changefreq' => 'yearly'],
    ['url' => '/cart.php', 'priority' => '0.5', 'changefreq' => 'yearly'],
    ['url' => '/checkout.php', 'priority' => '0.5', 'changefreq' => 'yearly'],
];

foreach ($static_pages as $page) {
    echo '<url>';
    echo '<loc>' . $base_url . $page['url'] . '</loc>';
    echo '<priority>' . $page['priority'] . '</priority>';
    echo '<changefreq>' . $page['changefreq'] . '</changefreq>';
    echo '<lastmod>' . date('Y-m-d') . '</lastmod>';
    echo '</url>';
}

// Category pages
try {
    $stmt = $pdo->query("SELECT DISTINCT category FROM products WHERE is_active = 1 ORDER BY category");
    $categories = $stmt->fetchAll(PDO::FETCH_COLUMN);

    foreach ($categories as $category) {
        $category_slug = strtolower(str_replace(' ', '-', $category));
        echo '<url>';
        echo '<loc>' . $base_url . '/category.php?cat=' . urlencode($category_slug) . '</loc>';
        echo '<priority>0.8</priority>';
        echo '<changefreq>weekly</changefreq>';
        echo '<lastmod>' . date('Y-m-d') . '</lastmod>';
        echo '</url>';
    }
} catch (Exception $e) {
    // Handle error silently
}

// Product pages with images
try {
    $stmt = $pdo->prepare("
        SELECT p.id, p.slug, p.updated_at,
               GROUP_CONCAT(pi.image_url SEPARATOR ',') as images
        FROM products p
        LEFT JOIN product_images pi ON p.id = pi.product_id
        WHERE p.is_active = 1
        GROUP BY p.id, p.slug, p.updated_at
        ORDER BY p.updated_at DESC
    ");
    $stmt->execute();
    $products = $stmt->fetchAll();

    foreach ($products as $product) {
        echo '<url>';
        echo '<loc>' . $base_url . '/product/' . $product['slug'] . '</loc>';
        echo '<priority>0.7</priority>';
        echo '<changefreq>weekly</changefreq>';
        echo '<lastmod>' . date('Y-m-d', strtotime($product['updated_at'])) . '</lastmod>';

        // Add images if available
        if ($product['images']) {
            $images = explode(',', $product['images']);
            foreach ($images as $image) {
                if (!empty($image)) {
                    echo '<image:image>';
                    echo '<image:loc>' . $base_url . '/' . ltrim($image, '/') . '</image:loc>';
                    echo '</image:image>';
                }
            }
        }

        echo '</url>';
    }
} catch (Exception $e) {
    // Handle error silently
}

echo '</urlset>';
?>